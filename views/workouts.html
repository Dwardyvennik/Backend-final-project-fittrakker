<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workout Manager — FitTrack</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<header class="navbar">
  <div class="nav-container">

    <div class="logo">FitTrack</div>

    <ul class="nav-links" id="nav-links">
      <li><a href="/">Dashboard</a></li>
      <li><a href="/workouts" class="active-link">Workouts</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>

  </div>
</header>

<section class="hero">
  <div class="hero-content">
    <h1>Workout Manager</h1>
    <p>Manage your training sessions with real-time MongoDB integration</p>
  </div>
</section>


<main class="main-content">

  <div class="dashboard-layout">

    <!-- SIDEBAR -->
    <aside class="dashboard-sidebar">

      <h3>Quick Info</h3>

      <div class="info-card">
        <p><strong>Project:</strong> FitTrack</p>
        <p><strong>Database:</strong> MongoDB</p>
        <p><strong>API:</strong> REST</p>
      </div>

      <h3>Tips</h3>

      <div class="info-card">
        <p>• Use filters to find workouts faster</p>
        <p>• Sort by duration or calories</p>
        <p>• Projection improves performance</p>
      </div>

    </aside>


    <!-- CONTENT -->
    <div class="dashboard-content">

      <!-- CREATE (Protected) -->
      <section class="section" id="create-section" style="display: none;">

        <h2>Create New Workout</h2>

        <div class="form-grid">

          <input type="text" id="titleInput" placeholder="Workout title">

          <select id="typeInput">
            <option value="strength">Strength</option>
            <option value="cardio">Cardio</option>
            <option value="yoga">Yoga</option>
          </select>

          <input type="number" id="durationInput" placeholder="Duration (min)">

          <input type="number" id="caloriesInput" placeholder="Calories">

          <select id="difficultyInput">
            <option value="Easy">Easy</option>
            <option value="Medium" selected>Medium</option>
            <option value="Hard">Hard</option>
          </select>

          <input type="text" id="notesInput" placeholder="Notes (optional)">

        </div>

        <button onclick="createWorkout()">Add Workout</button>

      </section>

      <div id="login-prompt" style="display: none; background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <p>Please <a href="/login" style="color: #38bdf8;">Login</a> to create or manage workouts.</p>
      </div>


      <!-- FILTERS -->
      <section class="section">

        <h2>Filters & Sorting</h2>

        <div class="form-grid">

          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="strength">Strength</option>
            <option value="cardio">Cardio</option>
            <option value="yoga">Yoga</option>
          </select>

          <select id="sortSelect">
            <option value="">No Sorting</option>
            <option value="duration">Sort by Duration</option>
            <option value="calories">Sort by Calories</option>
          </select>

          <label class="checkbox-row">
            <input type="checkbox" id="projectionCheck">
            Show only title + duration
          </label>

        </div>

        <button onclick="loadWorkouts()">Apply Filters</button>

      </section>


      <!-- LIST -->
      <section class="section">

        <h2>Workout List</h2>

        <div id="workoutsList" class="cards-grid"></div>

      </section>

    </div>

  </div>

</main>


<footer class="footer">
  © 2025 FitTrack
</footer>


<script>

let isAuthenticated = false;

// Check Auth on Load
async function checkAuth() {
  try {
    const res = await fetch("/api/auth/status");
    const data = await res.json();
    isAuthenticated = data.isAuthenticated;
    const nav = document.getElementById("nav-links");

    if (isAuthenticated) {
      document.getElementById("create-section").style.display = "block";
      document.getElementById("login-prompt").style.display = "none";
      
      const logoutLi = document.createElement("li");
      logoutLi.innerHTML = '<a href="#" onclick="logout()">Logout</a>';
      nav.appendChild(logoutLi);
    } else {
      document.getElementById("create-section").style.display = "none";
      document.getElementById("login-prompt").style.display = "block";

      const loginLi = document.createElement("li");
      loginLi.innerHTML = '<a href="/login">Login</a>';
      nav.appendChild(loginLi);
    }
  } catch (e) {
    console.error("Auth check failed", e);
  }
  loadWorkouts();
}

async function logout() {
  await fetch("/api/auth/logout", { method: "POST" });
  window.location.reload();
}

// CREATE
async function createWorkout() {

  const title = titleInput.value;
  const type = typeInput.value;
  const duration = durationInput.value;
  const calories = caloriesInput.value;
  const difficulty = difficultyInput.value;
  const notes = notesInput.value;

  if (!title || !duration) {
    alert("Title and duration are required");
    return;
  }

  const res = await fetch("/api/workouts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title,
      type,
      duration: Number(duration),
      calories: Number(calories),
      difficulty,
      notes
    })
  });

  if (res.status === 401) {
    alert("Unauthorized. Please login.");
    window.location.href = "/login";
    return;
  }

  if (res.ok) {
    titleInput.value = "";
    durationInput.value = "";
    caloriesInput.value = "";
    notesInput.value = "";
    loadWorkouts();
  } else {
    alert("Error creating workout");
  }
}


// DELETE
async function deleteWorkout(id) {

  if (!confirm("Delete this workout?")) return;

  const res = await fetch(`/api/workouts/${id}`, {
    method: "DELETE"
  });

  if (res.status === 401) {
    alert("Unauthorized. Please login.");
    return;
  }

  loadWorkouts();
}


// LOAD DATA
async function loadWorkouts() {

  const type = typeFilter.value;
  const sort = sortSelect.value;
  const projection = projectionCheck.checked;

  let url = "/api/workouts?";

  if (type) url += `type=${type}&`;
  if (sort) url += `sort=${sort}&`;
  if (projection) url += "fields=title,duration";

  const res = await fetch(url);
  const data = await res.json();

  const container = document.getElementById("workoutsList");
  container.innerHTML = "";

  if (data.length === 0) {
    container.innerHTML = "<p>No workouts found.</p>";
    return;
  }

  data.forEach(workout => {

    const card = document.createElement("div");
    card.className = "workout-card";

    let content = `<h3>${workout.title}</h3>`;
    
    if (workout.type) content += `<p><strong>Type:</strong> ${workout.type}</p>`;
    if (workout.duration) content += `<p><strong>Duration:</strong> ${workout.duration} min</p>`;
    if (workout.calories) content += `<p><strong>Calories:</strong> ${workout.calories}</p>`;
    if (workout.difficulty) content += `<p><strong>Difficulty:</strong> ${workout.difficulty}</p>`;
    if (workout.notes) content += `<p><strong>Notes:</strong> ${workout.notes}</p>`;

    if (isAuthenticated) {
      content += `<button onclick="deleteWorkout('${workout._id}')">Delete</button>`;
    }

    card.innerHTML = content;
    container.appendChild(card);
  });
}

checkAuth();

</script>

</body>
</html>